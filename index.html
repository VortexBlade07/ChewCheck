<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChewCheck - Fast Detection</title>

  <!-- Google Fonts - Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* (Same styling as before, unchanged) */
    /* Paste your original <style> section here without any change */
  </style>
</head>
<body>

  <!-- Name Popup -->
  <div id="namePopup">
    <div>
      <h3>üë§ Enter Your Name</h3>
      <input type="text" id="userNameInput" placeholder="Your name" style="padding: 10px; width: 80%; font-size: 1rem;" />
      <br><br>
      <button onclick="saveUserName()" style="padding: 10px 20px; font-size: 1rem;">Start</button>
    </div>
  </div>

  <!-- Greeting -->
  <p id="greeting"></p>

  <div class="container">
    <h1>ü¶∑ ChewCheck</h1>
    <div id="assistant">
      <img src="https://media.tenor.com/wVfhA-nP_7cAAAAi/tooth-cute.gif" alt="Assistant" />
    </div>

    <video id="video" autoplay playsinline muted></video>
    <div class="chew-count" id="chewCountDisplay"><i class="fas fa-teeth"></i> Chews: 0</div>
    <div class="button-group">
      <button id="startBtn"><i class="fas fa-video"></i> Start Webcam</button>
      <button id="stopBtn" disabled><i class="fas fa-stop-circle"></i> Stop Webcam</button>
    </div>

    <div class="final-report" id="finalReport">
      <div class="report-title">üìù Chewing Report</div>
      <p><strong>Total Chews:</strong> <span id="totalChews">0</span></p>
      <p><strong>Session Duration:</strong> <span id="sessionDuration">0 sec</span></p>
      <p><strong>Chews per Minute:</strong> <span id="chewsPerMin">0</span></p>
      <p><strong>Chewing Consistency:</strong> <span id="chewingConsistency">0%</span></p>
      <p class="chew-remark" id="chewRemark"><i class="fas fa-info-circle"></i> Start chewing to get feedback!</p>
    </div>
  </div>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <!-- Chew Detection Script -->
  <script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const chewCountDisplay = document.getElementById('chewCountDisplay');
    const finalReport = document.getElementById('finalReport');
    const totalChewsEl = document.getElementById('totalChews');
    const sessionDurationEl = document.getElementById('sessionDuration');
    const chewsPerMinEl = document.getElementById('chewsPerMin');
    const chewingConsistencyEl = document.getElementById('chewingConsistency');
    const chewRemarkEl = document.getElementById('chewRemark');

    let stream = null;
    let chewCount = 0;
    let camera = null;
    let startTime = null;
    let chewing = false;
    let lastChewTime = 0;

    const MOUTH_OPEN_THRESHOLD = 0.05;

    function getMouthOpenRatio(landmarks) {
      const top = landmarks[13];
      const bottom = landmarks[14];
      const left = landmarks[78];
      const right = landmarks[308];
      const vertical = Math.abs(top.y - bottom.y);
      const horizontal = Math.abs(left.x - right.x);
      return vertical / horizontal;
    }

    function onResults(results) {
      if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;
      const landmarks = results.multiFaceLandmarks[0];
      const ratio = getMouthOpenRatio(landmarks);

      const now = Date.now();
      if (ratio > MOUTH_OPEN_THRESHOLD && !chewing && now - lastChewTime > 300) {
        chewing = true;
      }

      if (ratio < MOUTH_OPEN_THRESHOLD && chewing) {
        chewCount++;
        chewing = false;
        lastChewTime = now;
        chewCountDisplay.innerHTML = `<i class="fas fa-teeth"></i> Chews: ${chewCount}`;
      }
    }

    const faceMesh = new FaceMesh({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });

    faceMesh.onResults(onResults);

    startBtn.onclick = async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 480, frameRate: { ideal: 30 } }
        });
        video.srcObject = stream;
        chewCount = 0;
        chewing = false;
        chewCountDisplay.innerHTML = `<i class="fas fa-teeth"></i> Chews: 0`;
        finalReport.style.display = "none";
        startTime = new Date();

        camera = new Camera(video, {
          onFrame: async () => {
            await faceMesh.send({ image: video });
          },
          width: 640,
          height: 480
        });

        camera.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (error) {
        console.error("Error accessing webcam:", error);
        alert("Could not start webcam. Please ensure you have a webcam and have granted permission.");
      }
    };

    stopBtn.onclick = () => {
      if (camera) camera.stop();
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }

      stopBtn.disabled = true;
      startBtn.disabled = false;

      const endTime = new Date();
      const durationSec = Math.floor((endTime - startTime) / 1000);
      const chewsPerMin = (chewCount / durationSec) * 60;
      const consistency = Math.min(100, Math.round((chewCount / (durationSec / 2)) * 100));

      totalChewsEl.textContent = chewCount;
      sessionDurationEl.textContent = `${durationSec} sec`;
      chewsPerMinEl.textContent = chewsPerMin.toFixed(1);
      chewingConsistencyEl.textContent = `${consistency}%`;

      let remark = "Start chewing to get feedback!";
      let remarkClass = "";
      let remarkIcon = "fas fa-info-circle";

      if (chewCount < 5) {
        remark = "You're chewing too little. Try to chew more!";
        remarkClass = "poor";
        remarkIcon = "fas fa-exclamation-triangle";
      } else if (chewsPerMin < 20) {
        remark = "Average chewing. Try to be consistent!";
        remarkClass = "average";
        remarkIcon = "fas fa-meh";
      } else {
        remark = "Great job! Very consistent chewing!";
        remarkClass = "good";
        remarkIcon = "fas fa-check-circle";
      }

      chewRemarkEl.innerHTML = `<i class="${remarkIcon}"></i> ${remark}`;
      chewRemarkEl.className = `chew-remark ${remarkClass}`;
      finalReport.style.display = "block";
    };

    // ‚úÖ FIXED VERSION
    function saveUserName() {
      const name = document.getElementById("userNameInput").value.trim();
      if (name) {
        document.getElementById("namePopup").style.display = "none";
        document.getElementById("greeting").innerText = `üëã Hello, ${name}! Chewing detection is ready.`;

        // Optionally auto-start webcam after entering name:
        setTimeout(() => startBtn.click(), 300); // Slight delay to prevent timing issues
      } else {
        alert("Please enter your name.");
      }
    }
  </script>

</body>
</html>
